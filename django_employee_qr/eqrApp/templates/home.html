{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home-design.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-title">
    <h3>Dashboard</h3>
</div>

<div class="dashboard-container">
    <!-- Members Card -->
    <div class="card members">
        <i class="fas fa-users"></i> <strong>Members</strong>
        <p class="display-4">{{ members_count }}</p>
        <div class="card-buttons">
            <a href="{% url 'eqrApp:member_list' %}">
                <i class="fa-solid fa-list-ul" style="color: #ffffff;"></i> View All
            </a>
            <a href="{% url 'eqrApp:add_member' %}">
                <i class="fa-solid fa-plus" style="color: #ffffff;"></i> Add New
            </a>
        </div>
    </div>

    <!-- Events Card -->
    <div class="card events">
        <i class="fas fa-calendar-alt"></i> <strong>Events</strong>
        <p class="display-4">{{ events_count }}</p>
        <div class="card-buttons">
            <a href="{% url 'eqrApp:event_list' %}">
                <i class="fa-solid fa-list-ul" style="color: #ffffff;"></i> View All
            </a>
            <a href="{% url 'eqrApp:create_event' %}">
                <i class="fa-solid fa-plus" style="color: #ffffff;"></i> Add New
            </a>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card recent-activity">
        <i class="fas fa-history"></i><strong>Recent Activity</strong>
        <ul>
            {% for event in recent_events %}
            <li>
                <a href="{% url 'eqrApp:event_detail' event.pk %}" class="event-link" data-event-id="{{ event.pk }}">
                    <i class="fas fa-calendar-day"></i> {{ event.name }} - {{ event.date|date:"M d, Y" }}
                </a>
            </li>
            {% empty %}
            <li>No recent events</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Attendance Summary Section -->
<div class="dashboard-container">
    <div class="card" style="flex: 1 1 100%; max-width: 100%;">
        <label for="event-select"><i class="fa-solid fa-clipboard"></i> Attendance Summary</label>
        <select id="event-select">
            {% for event in recent_events %}
            <option value="{{ event.pk }}" 
                    data-present="{{ event.present_count }}"
                    data-late="{{ event.late_count }}"
                    data-absent="{{ event.absent_count }}"
                    data-total="{{ event.total_members }}">
                {{ event.name }}
            </option>
            {% endfor %}
        </select>

        <div class="status-cards">
            <div class="status present">
                Present
                <p id="present-count">{{ present_count }}</p>
            </div>
            <div class="status absent">
                Absent
                <p id="absent-count">{{ absent_count }}</p>
            </div>
            <div class="status late">
                Late
                <p id="late-count">{{ late_count }}</p>
            </div>
        </div>
        <div class="total-members">
            Total Members: <span id="total-members">{{ total_members }}</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventSelect = document.getElementById('event-select');
    const presentCount = document.getElementById('present-count');
    const absentCount = document.getElementById('absent-count');
    const lateCount = document.getElementById('late-count');
    const totalMembers = document.getElementById('total-members');

    // Handle dropdown change
    eventSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        // Update counts
        presentCount.textContent = selectedOption.dataset.present;
        absentCount.textContent = selectedOption.dataset.absent;
        lateCount.textContent = selectedOption.dataset.late;
        totalMembers.textContent = selectedOption.dataset.total;
    });

    // Make event links in Recent Activity update the stats too
    document.querySelectorAll('.event-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const eventId = this.dataset.eventId;
            
            // Find the matching option in the dropdown
            const option = document.querySelector(`#event-select option[value="${eventId}"]`);
            if (option) {
                eventSelect.value = eventId;
                
                // Trigger the change event
                const event = new Event('change');
                eventSelect.dispatchEvent(event);
                
                // Navigate to the event detail page
                window.location.href = this.href;
            }
        });
    });
    eventSelect.addEventListener('change', function() {
        const eventId = this.value;
        
        fetch(`/api/events/${eventId}/attendance/`)
            .then(response => response.json())
            .then(data => {
                presentCount.textContent = data.present;
                absentCount.textContent = data.absent;
                lateCount.textContent = data.late;
                totalMembers.textContent = data.total_members;
            });
    });
    
});
</script>
{% endblock %}