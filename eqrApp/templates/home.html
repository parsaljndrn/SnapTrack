{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home-design.css' %}?v={{now}}">
{% endblock %}

{% block content %}

<div class="dashboard-container">
    <!-- Members Card -->
    <div class="card members">
        <i class="fas fa-users"></i> <strong>Members</strong>
        <p class="display-4">{{ members_count }}</p>
        <div class="card-buttons">
            <a href="{% url 'eqrApp:member_list' %}">
                <i class="fa-solid fa-list-ul" style="color: #ffffff;"></i> View All
            </a>
            <a href="{% url 'eqrApp:add_member' %}">
                <i class="fa-solid fa-plus" style="color: #ffffff;"></i> Add New
            </a>
        </div>
    </div>

    <!-- Events Card -->
    <div class="card events">
        <i class="fas fa-calendar-alt"></i> <strong>Events</strong>
        <p class="display-4">{{ events_count }}</p>
        <div class="card-buttons">
            <a href="{% url 'eqrApp:event_list' %}">
                <i class="fa-solid fa-list-ul" style="color: #ffffff;"></i> View All
            </a>
            <a href="{% url 'eqrApp:create_event' %}">
                <i class="fa-solid fa-plus" style="color: #ffffff;"></i> Add New
            </a>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card recent-activity">
        <i class="fas fa-history"></i><strong>Recent Activity</strong>
        <ul>
            {% for event in recent_events %}
            <li>
                <a href="{% url 'eqrApp:event_detail' event.pk %}" class="event-link" data-event-id="{{ event.pk }}">
                    <i class="fas fa-calendar-day"></i> {{ event.name }} - {{ event.date|date:"M d, Y" }}
                </a>
            </li>
            {% empty %}
            <li>No recent events</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Attendance Summary Section -->
{% if recent_events %}
<div class="dashboard-container">
    <div class="card" style="flex: 1 1 100%; max-width: 100%;">
        <label for="event-select"><i class="fa-solid fa-clipboard"></i> Attendance Summary</label>
        <select id="event-select">
            {% for event in recent_events %}
            <option value="{{ event.pk }}">
                {{ event.name }} - {{ event.date|date:"M d, Y" }}
            </option>
            {% endfor %}
        </select>

        <div class="status-cards">
            <div class="status present">
                Present
                <p id="present-count">{{ present_count|default:0 }}</p>
            </div>
            <div class="status absent">
                Absent
                <p id="absent-count">{{ absent_count|default:0 }}</p>
            </div>
            <div class="status late">
                Late
                <p id="late-count">{{ late_count|default:0 }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventSelect = document.getElementById('event-select');
    const presentCount = document.getElementById('present-count');
    const absentCount = document.getElementById('absent-count');
    const lateCount = document.getElementById('late-count');

    // Only run this if we have the elements
    if (eventSelect && presentCount && absentCount && lateCount) {
        function updateAttendanceStats(eventId) {
            // Show loading state
            presentCount.textContent = '...';
            absentCount.textContent = '...';
            lateCount.textContent = '...';

            fetch(`{% url 'eqrApp:event_attendance_stats' 0 %}`.replace('0', eventId))
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    presentCount.textContent = data.present || 0;
                    absentCount.textContent = data.absent || 0;
                    lateCount.textContent = data.late || 0;
                })
                .catch(error => {
                    console.error('Error fetching attendance stats:', error);
                    presentCount.textContent = '0';
                    absentCount.textContent = '0';
                    lateCount.textContent = '0';
                });
        }

        // Initial load for the first event
        if (eventSelect.value) {
            updateAttendanceStats(eventSelect.value);
        }

        // Update stats when event selection changes
        eventSelect.addEventListener('change', function() {
            updateAttendanceStats(this.value);
        });

        // Optional: update stats when clicking recent activity links
        document.querySelectorAll('.event-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const eventId = this.dataset.eventId;
                const option = document.querySelector(`#event-select option[value="${eventId}"]`);
                if (option) {
                    eventSelect.value = eventId;
                    updateAttendanceStats(eventId);
                }
            });
        });
    }
});
</script>
{% endblock %}