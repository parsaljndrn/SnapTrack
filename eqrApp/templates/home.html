{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home-design.css' %}?v={{now}}">
{% endblock %}

{% block content %}

<div class="dashboard-container">
    <!-- Members Card -->
    <div class="card members">
        <i class="fas fa-users"></i> <strong>Members</strong>
        <p class="display-4">{{ members_count }}</p>
        <div class="card-buttons">
            <a href="{% url 'eqrApp:member_list' %}">
                <i class="fa-solid fa-list-ul" style="color: #ffffff;"></i> View All
            </a>
            <a href="{% url 'eqrApp:add_member' %}">
                <i class="fa-solid fa-plus" style="color: #ffffff;"></i> Add New
            </a>
        </div>
    </div>

    <!-- Events Card -->
    <div class="card events">
        <i class="fas fa-calendar-alt"></i> <strong>Events</strong>
        <p class="display-4">{{ events_count }}</p>
        <div class="card-buttons">
            <a href="{% url 'eqrApp:event_list' %}">
                <i class="fa-solid fa-list-ul" style="color: #ffffff;"></i> View All
            </a>
            <a href="{% url 'eqrApp:create_event' %}">
                <i class="fa-solid fa-plus" style="color: #ffffff;"></i> Add New
            </a>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card recent-activity">
        <i class="fas fa-history"></i><strong>Recent Activity</strong>
        <ul>
            {% for event in recent_events %}
            <li>
                <a href="{% url 'eqrApp:event_detail' event.pk %}" class="event-link" data-event-id="{{ event.pk }}">
                    <i class="fas fa-calendar-day"></i> {{ event.name }} - {{ event.date|date:"M d, Y" }}
                </a>
            </li>
            {% empty %}
            <li>No recent events</li>
            {% endfor %}
        </ul>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventSelect = document.getElementById('event-select');
    const presentCount = document.getElementById('present-count');
    const absentCount = document.getElementById('absent-count');
    const lateCount = document.getElementById('late-count');

    function updateAttendanceStats(eventId) {
        // Show loading state
        presentCount.textContent = '...';
        absentCount.textContent = '...';
        lateCount.textContent = '...';

        fetch(`/api/events/${eventId}/attendance/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                presentCount.textContent = data.present;
                absentCount.textContent = data.absent;
                lateCount.textContent = data.late;
            })
            .catch(error => {
                console.error('Error fetching attendance stats:', error);
                presentCount.textContent = '0';
                absentCount.textContent = '0';
                lateCount.textContent = '0';
            });
    }

    // Initial load for the first event
    if (eventSelect.value) {
        updateAttendanceStats(eventSelect.value);
    }

    // Update stats when event selection changes
    eventSelect.addEventListener('change', function() {
        updateAttendanceStats(this.value);
    });

    // Optional: update stats when clicking recent activity links
    document.querySelectorAll('.event-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const eventId = this.dataset.eventId;
            const option = document.querySelector(`#event-select option[value="${eventId}"]`);
            if (option) {
                eventSelect.value = eventId;
                updateAttendanceStats(eventId);
            }
        });
    });
});
</script>
{% endblock %}